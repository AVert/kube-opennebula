FROM ubuntu:18.04 as builder
ARG VERSION=5.8.4

# Install build dependencies
RUN apt-get update \
 && apt-get install -y pbuilder debhelper ubuntu-dev-tools bash-completion \
      bison default-jdk flex javahelper libxmlrpc3-client-java \
      libxmlrpc3-common-java libxml2-dev ruby scons dh-systemd \
      npm ruby-ronn rename

# Download sources
RUN wget -O - https://github.com/OpenNebula/one/archive/release-$VERSION.tar.gz | tar xzf - \
 && mv one-release-$VERSION opennebula-$VERSION
WORKDIR /opennebula-$VERSION

# Apply patches
RUN curl https://patch-diff.githubusercontent.com/raw/OpenNebula/one/pull/3569.patch | patch -p1
RUN echo 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 | base64 -d | gunzip | patch -p1

# Make docs
RUN cd share/man \
 && ./build.sh

# Make sunstone
RUN cd src/sunstone/public \
 && ./build.sh -d \
 && export PATH=$PATH:$PWD/node_modules/.bin \
 && ./build.sh \
 && rm -rf node_modules/

# Prepare packages
RUN tar -czf /opennebula-$VERSION.tar.gz /opennebula-$VERSION/
RUN wget -O - https://github.com/OpenNebula/packages/archive/release-$VERSION.tar.gz | tar xzf - \
 && mv packages-release-$VERSION /packages-$VERSION
WORKDIR /packages-$VERSION
RUN sed -i '/^debuild/,$ s/^/#/' ubuntu1804.sh \
 && ./ubuntu1804.sh /opennebula-$VERSION.tar.gz

# Build packages
WORKDIR /root/build-Ubuntu-18.04/opennebula-$VERSION
RUN apt-get install -y $(dpkg-checkbuilddeps 2>&1 | sed 's/.*Unmet build dependencies: //') \
 && echo build_opennebula.tar.gz >> debian/source/include-binaries \
 && echo xmlrpc-c.tar.gz >> debian/source/include-binaries \
 && dpkg-buildpackage -us -uc \
 && mkdir -p /packages \
 && mv /root/build-Ubuntu-18.04/*.deb /packages/


FROM ubuntu:18.04

# Install opennebula-gems
COPY --from=builder packages/opennebula-common_*.deb packages/ruby-opennebula_*_all.deb packages/opennebula-tools_*.deb /packages/
RUN apt-get update \
 && apt-get -y install /packages/*.deb \
 && sed -i 's/apt-get install/apt-get -y install/g' /usr/share/one/install_gems \
 && echo '0\n' | /usr/share/one/install_gems \
 && mkdir -p /var/log/one /var/lock/one \
 && apt-get -y clean \
 && chown oneadmin: /var/log/one /var/lock/one

# Install opennebula-sunstone
COPY --from=builder packages/opennebula-sunstone_*.deb /packages/
RUN apt-get -y update \
 && ln -s /bin/true /usr/local/bin/systemd-tmpfiles \
 && dpkg -i packages/opennebula-sunstone_*.deb || true \
 && apt-get -yf install \
 && dpkg -l opennebula-sunstone \
 && rm -f /usr/local/bin/systemd-tmpfiles \
 && apt-get -y clean

# Logging to /dev/stdout, do not daemonize novnc-server
RUN sed -i 's|^\(SUNSTONE_LOG *=\).*|\1 "/dev/stdout"|' /usr/lib/one/sunstone/sunstone-server.rb \
 && sed -i 's|^\(VNC_LOG *=\).*|\1 "/dev/stdout"|' /usr/bin/novnc-server \
 && sed -i '/cmd *=/a\        exec(cmd)' /usr/lib/one/ruby/OpenNebulaVNC.rb

USER oneadmin
ENTRYPOINT [ "/usr/bin/ruby", "/usr/lib/one/sunstone/sunstone-server.rb" ]
#ENTRYPOINT [ "/usr/bin/ruby", "/usr/bin/novnc-server", "start" ]
